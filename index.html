<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>极简云工具 - 视频/图片/文件全能处理</title>
    <!-- 增强CSP策略 -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; worker-src 'self' blob:; script-src 'self' https://cdn.tailwindcss.com https://cdn.jsdelivr.net 'unsafe-inline'; style-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; img-src 'self' data: https://picsum.photos; font-src 'self'; connect-src 'self' https://cdn.jsdelivr.net; object-src 'none'; frame-src 'self' https://github.com; base-uri 'self';">
    <!-- PWA配置 -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#3b82f6">
    <link rel="apple-touch-icon" href="/icon-192x192.png">
    <!-- 依赖库 -->
    <script src="https://cdn.tailwindcss.com" integrity="sha256-7v4Q0L90R6AgrlLz74YoY1A8X7pk26hO7HCVZ13Lw98=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2.1.0/dist/pako.min.js" integrity="sha256-4I1YZB9hKb0eV94aVn7QXHw86nq0O8tQq1q3xIG5iY=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/compressorjs@1.2.1/dist/compressor.min.js" integrity="sha256-6Z85sW582L10c28cq62V0oXQ0kL0e4lAh6B8H/fbHk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.min.js" integrity="sha256-9X7eT7Z8mGp3dU8bWXoH3Qe9j8r4VjBz4zrwWw4aG8=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.5.0/build/index.min.js" integrity="sha256-7F7Qe9n8X8f38Z7YHw8pQ6s6X7jw7pO83xG6J7k1mU=" crossorigin="anonymous"></script>
    <style>
        /* 原有样式保持不变 */
        .progress-bar-container { width: 100%; background-color: #e5e7eb; border-radius: 9999px; height: 8px; }
        .progress-bar { height: 100%; background-color: #3b82f6; border-radius: 9999px; }
        /* 新增加载动画 */
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 导航栏保持不变 -->

    <!-- 功能区 -->
    <main class="container mx-auto px-4 py-12">
        <!-- 文本提取模块改进 -->
        <section id="text-extractor">
            <div class="card bg-white rounded-lg shadow p-6 max-w-3xl mx-auto">
                <!-- ... 其他元素保持不变 ... -->
                <!-- 增强的提取状态显示 -->
                <div id="extract-status" class="mb-4 text-sm text-gray-600 hidden">
                    <div class="loader"></div>
                    <span>正在提取文本，请稍候...</span>
                </div>
                <!-- 扫描件错误提示 -->
                <div id="scan-pdf-warning" class="mb-4 p-3 bg-yellow-50 text-yellow-800 rounded-md hidden">
                    <svg class="w-5 h-5 inline mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    检测到扫描件PDF，文本提取功能仅支持可搜索的PDF文档
                </div>
                <!-- ... 其他元素保持不变 ... -->
            </div>
        </section>
    </main>

    <script>
        // ====================== 文本提取模块增强 ======================
        const docUpload = document.getElementById('doc-upload');
        const extractStatus = document.getElementById('extract-status');
        const scanPdfWarning = document.getElementById('scan-pdf-warning');
        const textContent = document.getElementById('text-content');
        
        // 初始化PDF.js
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.4.120/build/pdf.worker.min.js';

        docUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // 重置状态
            extractStatus.classList.remove('hidden');
            scanPdfWarning.classList.add('hidden');
            extractResult.classList.add('hidden');

            try {
                if (file.name.endsWith('.pdf')) {
                    extractedText = await extractPdfText(file);
                    
                    // 增强扫描件检测
                    if (!extractedText.trim()) {
                        scanPdfWarning.classList.remove('hidden');
                        extractStatus.classList.add('hidden');
                        return;
                    }
                }
                // ... 其他处理逻辑保持不变 ...
            } catch (err) {
                console.error('文本提取失败:', err);
                alert(`文本提取失败: ${err.message}`);
            } finally {
                extractStatus.classList.add('hidden');
            }
        });

        // ====================== 图片压缩模块增强 ======================
        const imageUpload = document.getElementById('image-upload');
        
        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            // 验证文件类型
            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!validTypes.includes(file.type)) {
                alert('请选择 JPG, PNG 或 WebP 格式的图片');
                imageUpload.value = '';
                return;
            }
            
            // ... 其他处理逻辑保持不变 ...
        });

        // ====================== PWA 服务注册增强 ======================
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    
                    // 检测更新
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed') {
                                if (navigator.serviceWorker.controller) {
                                    // 提示用户更新
                                    if (confirm('新版本可用，是否立即更新？')) {
                                        newWorker.postMessage({ action: 'skipWaiting' });
                                    }
                                }
                            }
                        });
                    });
                    
                    // 检查是否有更新
                    await registration.update();
                } catch (err) {
                    console.error('SW 注册失败:', err);
                }
            });
        }

        // 监听服务worker消息
        navigator.serviceWorker.addEventListener('controllerchange', () => {
            window.location.reload();
        });
    </script>
</body>
</html>